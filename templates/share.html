<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <title>PathFinder — Visualização (somente leitura)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta property="og:title" content="Conexões no FamilySearch" />
  <meta property="og:description" content="Visualização compartilhada do PathFinder (somente leitura)" />
  <meta property="og:type" content="website" />
  <style>
    body{font-family:system-ui,-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Oxygen,Ubuntu,Cantarell,'Open Sans','Helvetica Neue',sans-serif;background:#f4f4f9;margin:0}
    .container{max-width:920px;margin:24px auto;background:#fff;border-radius:10px;box-shadow:0 4px 10px rgba(0,0,0,.08);padding:28px}
    .header { text-align: center; border-bottom: 1px solid #e0e0e0; padding-bottom: 20px; margin-bottom: 20px; }
    .header .logo img { max-width: 120px; }
    h1{margin:0 0 4px;color:#0a4a86}
    .muted{color:#666;font-size:.95rem;margin-bottom:18px}
    .banner{background:#fff3cd;border:1px solid #ffe69c;color:#7a5a00;padding:10px 12px;border-radius:8px;margin-bottom:14px}
    .path-card{border:1px solid #eee;border-radius:8px;padding:14px 14px 8px;margin:16px 0 24px}
    .title-row{display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap}
    .title-row h2{font-size:1rem;margin:0}
    .btn{appearance:none;border:1px solid #d0d7de;background:#fff;border-radius:6px;padding:8px 12px;font-size:.9rem;cursor:pointer}
    .btn:hover{background:#f6f8fa}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap}
    .mermaid-wrap{border:1px solid #eee;border-radius:8px;background:#fafafa;margin-top:10px;overflow:auto;padding:10px}
    footer{margin-top:18px;color:#888;font-size:.9rem;text-align:center}
    .error{background:#fde7e9;border:1px solid #f5c2c7;color:#842029;padding:10px 12px;border-radius:8px;margin:12px 0}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
</head>
<body>
  <div class="container">
    <div class="header">
        <div class="logo">
            <a href="{{ url_for('index') }}"><img src="{{ url_for('static', filename='images/logo.png') }}" alt="PathFinder Logo"></a>
        </div>
    </div>
    <h1>PathFinder — Visualização</h1>
    <div class="banner">Beta — resultados podem conter imprecisões.</div>

    <div class="muted">
      Somente leitura • IDs: {{ data.person1_id }} → {{ data.person2_id }} • Profundidade: {{ data.max_depth }}
    </div>

    <div class="toolbar" style="margin-bottom:12px">
      <button class="btn" id="btnCopyLink">Copiar link</button>
    </div>

    {% if not data.paths or data.paths|length == 0 %}
      <div class="error">Não foi possível calcular o relacionamento com acesso público.</div>
    {% endif %}

    {% for p in data.paths %}
      <div class="path-card">
        <div class="title-row">
          <h2>
            Caminho {{ loop.index }} — {{ p.p1_name }} → {{ p.p2_name }}
            {% if p.degree_label %} • <em>{{ p.degree_label }}</em>{% endif %}
          </h2>
          <div class="toolbar">
            <button class="btn" onclick="downloadSVG({{ loop.index0 }})">Baixar SVG</button>
            <button class="btn" onclick="downloadPNG({{ loop.index0 }})">Baixar PNG</button>
            <button class="btn" onclick="downloadPDF({{ loop.index0 }})">Baixar PDF</button>
          </div>
        </div>
        <div class="mermaid-wrap">
          <div class="mermaid" id="g{{ loop.index0 }}">{{ p.mermaid_data | safe }}</div>
        </div>
      </div>
    {% endfor %}

    <footer>Visualização pública instantânea • Compartilhamento: {{ slug }}</footer>
  </div>

<script>
  mermaid.initialize({ startOnLoad:false, securityLevel:'loose', theme:'default' });
  document.addEventListener('DOMContentLoaded', () => {
    const graphs = document.querySelectorAll('.mermaid');
    if (graphs.length) mermaid.run({ nodes: graphs });
    document.getElementById('btnCopyLink')?.addEventListener('click', async () => {
      try {
        await navigator.clipboard.writeText(window.location.href);
        alert('Link copiado!');
      } catch { alert('Não foi possível copiar. Copie manualmente da barra do navegador.'); }
    });
  });

  /* --- Funções de Exportação Robustas --- */
  async function getSvgAndTitle(idx){
    const card = document.querySelectorAll('.path-card')[idx];
    if (!card) return {};
    const svg = card.querySelector('.mermaid svg');
    if(!svg){ alert('Gráfico ainda não foi renderizado.'); return {}; }
    const title = (card.querySelector('h2')?.innerText || `Caminho ${idx+1}`).trim();
    const xml = new XMLSerializer().serializeToString(svg);
    const source = `<?xml version="1.0" encoding="UTF-8"?>\n` + xml;
    return { source, title, svg };
  }

  async function downloadSVG(idx){
    const { source, title } = await getSvgAndTitle(idx);
    if(!source) return;
    const blob = new Blob([source], {type:'image/svg+xml;charset=utf-8'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `PathFinder - ${title}.svg`;
    document.body.appendChild(a); a.click();
    setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); }, 0);
  }
  window.downloadSVG = downloadSVG;
  
  async function downloadPNG(idx){
    const { source, title, svg } = await getSvgAndTitle(idx);
    if(!source) return;
    const url = 'data:image/svg+xml;charset=utf-8,' + encodeURIComponent(source);
    const img = new Image();
    img.onload = function(){
      const { width, height } = svg.getBoundingClientRect();
      const SCALE = 2;
      const PAD = 20;
      const canvas = document.createElement('canvas');
      canvas.width = (width + PAD*2) * SCALE;
      canvas.height = (height + PAD*2) * SCALE;
      const ctx = canvas.getContext('2d');
      ctx.scale(SCALE, SCALE);
      ctx.fillStyle = '#FFFFFF';
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      ctx.drawImage(img, PAD, PAD);
      
      canvas.toBlob((blob)=>{
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `PathFinder - ${title}.png`;
        document.body.appendChild(a); a.click();
        setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); }, 0);
      }, 'image/png');
    };
    img.onerror = ()=>alert('Falha ao rasterizar o SVG.');
    img.src = url;
  }
  window.downloadPNG = downloadPNG;

  async function ensureJsPDF(){
    if (window.jspdf?.jsPDF) return window.jspdf.jsPDF;
    return new Promise((resolve, reject) => {
      const s = document.createElement('script');
      s.src = 'https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js';
      s.onload = () => resolve(window.jspdf.jsPDF);
      s.onerror = () => reject(new Error('Falha ao carregar jsPDF'));
      document.head.appendChild(s);
    });
  }

  async function downloadPDF(idx){
    const { source, title, svg } = await getSvgAndTitle(idx);
    if(!source) return;
    const jsPDF = await ensureJsPDF();

    const url = 'data:image/svg+xml;charset=utf-8,' + encodeURIComponent(source);
    const img = new Image();
    img.onload = () => {
      const { width, height } = svg.getBoundingClientRect();
      const SCALE = 2;
      const PAD = 40;

      const canvas = document.createElement('canvas');
      canvas.width  = Math.round((width + PAD*2) * SCALE);
      canvas.height = Math.round((height + PAD*2) * SCALE);
      const ctx = canvas.getContext('2d');
      ctx.scale(SCALE, SCALE);
      ctx.fillStyle = '#FFFFFF';
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      ctx.drawImage(img, PAD, PAD);
      
      const totalW = width + PAD*2;
      const totalH = height + PAD*2;
      const landscape = totalW >= totalH;
      const pdf = new jsPDF({ orientation: landscape ? 'l' : 'p', unit: 'pt', format: 'a4' });
      
      const pageW = pdf.internal.pageSize.getWidth();
      const pageH = pdf.internal.pageSize.getHeight();
      const margin = 24;
      const maxW = pageW - margin*2;
      const maxH = pageH - margin*2;
      
      let drawW = maxW, drawH = totalH * (maxW / totalW);
      if (drawH > maxH) { drawH = maxH; drawW = totalH * (maxH / totalH); }
      
      const x = (pageW - drawW)/2;
      const y = (pageH - drawH)/2;
      
      pdf.addImage(canvas.toDataURL('image/png'), 'PNG', x, y, drawW, drawH);
      pdf.save(`PathFinder - ${title}.pdf`);
    };
    img.onerror = () => alert('Falha ao ler o SVG para imagem.');
    img.src = url;
  }
  window.downloadPDF = downloadPDF;
</script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js" defer></script>
</body>
</html>