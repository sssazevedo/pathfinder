<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <title>PathFinder — Visualização (somente leitura)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- OpenGraph para prévias em WhatsApp/Slack -->
  <meta property="og:title" content="Conexões no FamilySearch" />
  <meta property="og:description" content="Visualização compartilhada do PathFinder (somente leitura)" />
  <meta property="og:type" content="website" />
  <style>
    body{font-family:system-ui,-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Oxygen,Ubuntu,Cantarell,'Open Sans','Helvetica Neue',sans-serif;background:#f4f4f9;margin:0}
    .container{max-width:920px;margin:24px auto;background:#fff;border-radius:10px;box-shadow:0 4px 10px rgba(0,0,0,.08);padding:28px}
    h1{margin:0 0 4px;color:#0a4a86}
    .muted{color:#666;font-size:.95rem;margin-bottom:18px}
    .banner{background:#fff3cd;border:1px solid #ffe69c;color:#7a5a00;padding:10px 12px;border-radius:8px;margin-bottom:14px}
    .path-card{border:1px solid #eee;border-radius:8px;padding:14px 14px 8px;margin:16px 0 24px}
    .title-row{display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap}
    .title-row h2{font-size:1rem;margin:0}
    .btn{appearance:none;border:1px solid #d0d7de;background:#fff;border-radius:6px;padding:8px 12px;font-size:.9rem;cursor:pointer}
    .btn:hover{background:#f6f8fa}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap}
    .mermaid-wrap{border:1px solid #eee;border-radius:8px;background:#fafafa;margin-top:10px;overflow:auto;padding:10px}
    footer{margin-top:18px;color:#888;font-size:.9rem;text-align:center}
    .error{background:#fde7e9;border:1px solid #f5c2c7;color:#842029;padding:10px 12px;border-radius:8px;margin:12px 0}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
</head>
<body>
  <div class="container">
    <h1>PathFinder — Visualização</h1>
    <div class="banner">Beta — resultados podem conter imprecisões.</div>

    <div class="muted">
      Somente leitura • IDs: {{ data.person1_id }} → {{ data.person2_id }} • Profundidade: {{ data.max_depth }}
    </div>

    <div class="toolbar" style="margin-bottom:12px">
      <button class="btn" id="btnCopyLink">Copiar link</button>
    </div>

    {% if not data.paths or data.paths|length == 0 %}
      <div class="error">Não foi possível calcular o relacionamento com acesso público.</div>
    {% endif %}

    {% for p in data.paths %}
      <div class="path-card">
        <div class="title-row">
          <h2>
            Caminho {{ loop.index }} — {{ p.p1_name }} → {{ p.p2_name }}
            {% if p.degree_label %} • <em>{{ p.degree_label }}</em>{% endif %}
          </h2>
          <div class="toolbar">
            <button class="btn" onclick="downloadSVG({{ loop.index0 }})">Baixar SVG</button>
            <button class="btn" onclick="downloadPNG({{ loop.index0 }})">Baixar PNG</button>
            <button class="btn" onclick="downloadPDF({{ loop.index0 }})">Baixar PDF</button>
          </div>
        </div>
        <div class="mermaid-wrap">
          <div class="mermaid" id="g{{ loop.index0 }}">{{ p.mermaid_data | safe }}</div>
        </div>
      </div>
    {% endfor %}

    <footer>Visualização pública instantânea • Compartilhamento: {{ slug }}</footer>
  </div>

<script>
  // Mermaid
  mermaid.initialize({ startOnLoad:false, securityLevel:'loose', theme:'default' });
  document.addEventListener('DOMContentLoaded', () => {
    const graphs = document.querySelectorAll('.mermaid');
    if (graphs.length) mermaid.run({ nodes: graphs });

    // Copiar link
    document.getElementById('btnCopyLink')?.addEventListener('click', async () => {
      try {
        await navigator.clipboard.writeText(window.location.href);
        alert('Link copiado!');
      } catch { alert('Não foi possível copiar. Copie manualmente da barra do navegador.'); }
    });
  });

  // ---- Export helpers ----
  function svgTextOf(idx){
    const svg = document.querySelector(`#g${idx} svg`);
    if(!svg){ alert('Gráfico ainda não foi renderizado.'); return null; }
    const xml = new XMLSerializer().serializeToString(svg);
    return `<?xml version="1.0" encoding="UTF-8"?>\n` + xml;
  }
  function titleOf(idx){
    const h2s = document.querySelectorAll('.path-card .title-row h2');
    return (h2s[idx]?.innerText || `Caminho ${idx+1}`).trim();
  }
  function download(filename, mime, content){
    const blob = new Blob([content], {type:mime});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); }, 0);
  }
  window.downloadSVG = function(idx){
    const txt = svgTextOf(idx);
    if(!txt) return;
    download(`pathfinder-${idx+1}.svg`, 'image/svg+xml;charset=utf-8', txt);
  }
  window.downloadPNG = function(idx){
    const txt = svgTextOf(idx);
    if(!txt) return;
    const img = new Image();
    img.onload = function(){
      const scale = 2; // 2x para boa definição
      const PAD   = 24; // margem para não cortar
      const w = img.width, h = img.height;

      const canvas = document.createElement('canvas');
      canvas.width = (w + PAD*2) * scale;
      canvas.height = (h + PAD*2) * scale;
      const ctx = canvas.getContext('2d');
      ctx.setTransform(scale,0,0,scale,PAD*scale,PAD*scale);
      ctx.drawImage(img, 0, 0);

      canvas.toBlob((blob)=>{
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `pathfinder-${idx+1}.png`;
        document.body.appendChild(a); a.click();
        setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); }, 0);
      }, 'image/png');
    };
    img.onerror = ()=>alert('Falha ao rasterizar o SVG.');
    img.src = 'data:image/svg+xml;charset=utf-8,' + encodeURIComponent(txt);
  }

  // ---- PDF com margem (sem cortes) ----
  async function ensureJsPDF(){
    if (window.jspdf?.jsPDF) return window.jspdf.jsPDF;
    await new Promise((resolve, reject) => {
      const s = document.createElement('script');
      s.src = 'https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js';
      s.onload = resolve;
      s.onerror = () => reject(new Error('Falha ao carregar jsPDF'));
      document.head.appendChild(s);
    });
    return window.jspdf.jsPDF;
  }
  window.downloadPDF = async function(idx){
    const txt = svgTextOf(idx);
    if(!txt) return;
    const jsPDF = await ensureJsPDF();

    // carrega o SVG como imagem
    const img = new Image();
    img.onload = () => {
      const w = Math.max(1, img.width);
      const h = Math.max(1, img.height);
      const SCALE = 2;
      const PAD   = 24; // margem (px)

      const canvas = document.createElement('canvas');
      canvas.width  = Math.round((w + PAD*2) * SCALE);
      canvas.height = Math.round((h + PAD*2) * SCALE);
      const ctx = canvas.getContext('2d');
      ctx.setTransform(SCALE,0,0,SCALE,PAD*SCALE,PAD*SCALE);
      ctx.drawImage(img, 0, 0);

      const totalW = w + PAD*2;
      const totalH = h + PAD*2;

      const landscape = totalW >= totalH;
      const pdf = new jsPDF({ orientation: landscape ? 'l' : 'p', unit: 'pt', format: 'a4' });

      const pageW = pdf.internal.pageSize.getWidth();
      const pageH = pdf.internal.pageSize.getHeight();
      const margin = 24;
      const maxW = pageW - margin*2;
      const maxH = pageH - margin*2;

      let drawW = maxW, drawH = totalH * (maxW / totalW);
      if (drawH > maxH) { drawH = maxH; drawW = totalW * (maxH / totalH); }

      const x = (pageW - drawW)/2;
      const y = (pageH - drawH)/2;

      pdf.addImage(canvas.toDataURL('image/png'), 'PNG', x, y, drawW, drawH);
      pdf.save(`PathFinder - ${titleOf(idx)}.pdf`);
    };
    img.onerror = () => alert('Falha ao ler o SVG para imagem.');
    img.src = 'data:image/svg+xml;charset=utf-8,' + encodeURIComponent(txt);
  }
</script>

<!-- jsPDF também pode ser pré-carregado (opcional) -->
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js" defer></script>
</body>
</html>
